<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‡Ÿé¤Šé£²é£Ÿ VLM Demo - AI æ™ºæ…§åˆ†æç³»çµ±</title>
    <style>
        :root {
            /* é†«ç™‚é¢¨æ ¼é…è‰² */
            --primary: #009688; /* é†«ç™‚ç¶  */
            --primary-dark: #00796b;
            --secondary: #2196f3; /* ç§‘æŠ€è— */
            --accent: #ff9800; /* è­¦ç¤ºæ©˜ */
            --danger: #f44336; /* å±éšªç´… */
            --success: #4caf50; /* å®‰å…¨ç¶  */
            --bg: #f4f7f6;
            --surface: #ffffff;
            --text-main: #333333;
            --text-sub: #666666;
            --border: #e0e0e0;
            --shadow: 0 4px 6px rgba(0,0,0,0.05);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text-main); line-height: 1.6; padding-bottom: 40px; }

        /* é€šç”¨å…ƒä»¶ */
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; margin-bottom: 20px; border: 1px solid var(--border); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; font-size: 1rem; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; width: 100%; box-shadow: 0 2px 4px rgba(0,150,136,0.3); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: rgba(0,150,136,0.1); }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; width: auto; }
        
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-gap { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        /* æ¨™é¡Œå€ */
        header { text-align: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #ddd; position: relative; }
        h1 { color: var(--primary-dark); font-size: 1.8rem; margin-bottom: 5px; }
        .subtitle { color: var(--text-sub); font-size: 0.95rem; }
        .reset-btn { position: absolute; right: 0; top: 0; font-size: 0.8rem; }

        /* ç—…äººè³‡è¨Šå¡ */
        .patient-card { background: linear-gradient(to right bottom, #ffffff, #f0fdfc); border-left: 5px solid var(--primary); }
        .patient-header { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed var(--border); }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; margin-right: 5px; margin-bottom: 5px; }
        .tag-disease { background: #e3f2fd; color: #1565c0; }
        .tag-allergy { background: #ffebee; color: #c62828; }
        .tag-med { background: #fff3e0; color: #ef6c00; }
        .patient-stats { display: flex; gap: 15px; font-size: 0.9rem; color: var(--text-sub); margin-bottom: 10px; }
        
        /* ä¸Šå‚³å€ */
        .upload-area { border: 2px dashed var(--primary); border-radius: var(--radius); padding: 30px; text-align: center; cursor: pointer; transition: 0.2s; position: relative; background: #fafafa; }
        .upload-area:hover { background: #f0fdfc; border-color: var(--primary-dark); }
        .upload-area input { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }
        .preview-img { max-width: 100%; max-height: 300px; border-radius: 8px; display: none; margin: 15px auto; object-fit: cover; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .upload-placeholder { color: #888; }
        .upload-placeholder strong { color: var(--primary); font-size: 1.1rem; }

        /* åˆ†æçµæœå€ */
        #result-section { display: none; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .result-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .food-name { font-size: 1.5rem; font-weight: bold; color: var(--text-main); }
        .confidence { font-size: 0.8rem; background: #eee; padding: 2px 6px; border-radius: 4px; color: #666; }
        
        .section-title { font-size: 1.1rem; font-weight: bold; margin: 15px 0 10px 0; border-left: 4px solid var(--secondary); padding-left: 10px; color: var(--text-main); }
        
        .chip-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip { background: #e0e0e0; padding: 5px 12px; border-radius: 16px; font-size: 0.9rem; }

        /* ç‡Ÿé¤Šè¡¨æ ¼èˆ‡é€²åº¦æ¢ */
        .nutrition-row { display: grid; grid-template-columns: 80px 1fr 50px; align-items: center; margin-bottom: 8px; font-size: 0.9rem; }
        .progress-bg { background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--secondary); width: 0%; transition: width 1s ease-out; }
        .val-danger { color: var(--danger); font-weight: bold; }
        .bar-danger { background: var(--danger); }
        .bar-warn { background: var(--accent); }

        /* å»ºè­°å€å¡Š */
        .recommendation-box { border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-top: 10px; }
        .rec-danger { background: #ffebee; border-color: #ffcdd2; }
        .rec-warn { background: #fff3e0; border-color: #ffe0b2; }
        .rec-safe { background: #e8f5e9; border-color: #c8e6c9; }
        
        .status-badge { display: inline-flex; align-items: center; padding: 5px 12px; border-radius: 20px; color: white; font-weight: bold; font-size: 0.9rem; margin-left: auto; }
        .bg-red { background: var(--danger); }
        .bg-orange { background: var(--accent); }
        .bg-green { background: var(--success); }

        .advice-list { list-style: none; padding: 0; }
        .advice-list li { position: relative; padding-left: 20px; margin-bottom: 8px; font-size: 0.95rem; }
        .advice-list li::before { content: "â€¢"; color: var(--primary); font-weight: bold; position: absolute; left: 0; }
        
        /* æ­·å²ç´€éŒ„ */
        .history-item { padding: 10px; border-bottom: 1px solid #eee; display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; cursor: pointer; transition: 0.2s; }
        .history-item:hover { background: #f9f9f9; }
        .history-date { font-size: 0.8rem; color: #888; }
        .history-food { font-weight: 600; }
        
        /* Loading */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; display: none; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* SVG Icons */
        .icon { width: 20px; height: 20px; fill: currentColor; vertical-align: middle; }

        @media (max-width: 600px) {
            .grid-2 { grid-template-columns: 1fr; }
            .patient-stats { flex-wrap: wrap; gap: 10px; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ç‡Ÿé¤Šé£²é£Ÿ VLM Demo</h1>
        <p class="subtitle">æ‹ç…§è¾¨è­˜é£Ÿç‰© â€¢ ä¼°ç®—ç‡Ÿé¤Š â€¢ æä¾›æ‚£è€…å€‹äººåŒ–å»ºè­°</p>
        <button class="btn btn-outline btn-sm reset-btn" onclick="app.resetDemo()">
            <svg class="icon" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            é‡ç½®
        </button>
    </header>

    <div class="card patient-card">
        <div class="patient-header flex-between">
            <h3 style="display:flex; align-items:center; gap:8px;">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                <span id="p-name">è¼‰å…¥ä¸­...</span>
            </h3>
            <button class="btn btn-outline btn-sm" onclick="app.switchPatient()">åˆ‡æ›ç—…äºº</button>
        </div>
        <div class="patient-stats">
            <span id="p-basic"></span>
            <span>BMI: <strong id="p-bmi"></strong></span>
        </div>
        <div style="margin-top: 10px;">
            <div style="margin-bottom:5px;"><small>è¨ºæ–·/ç–¾ç—…ï¼š</small><span id="p-diseases"></span></div>
            <div style="margin-bottom:5px;"><small>ç”¨è—¥ï¼š</small><span id="p-meds"></span></div>
            <div style="margin-bottom:5px;"><small>éæ•åŸï¼š</small><span id="p-allergies"></span></div>
            <div><small>å¥åº·ç›®æ¨™ï¼š</small><span id="p-goal" style="color:var(--primary-dark); font-weight:bold;"></span></div>
        </div>
    </div>

    <div class="card">
        <div class="upload-area" id="drop-zone">
            <input type="file" id="file-input" accept="image/*" onchange="app.handleFileSelect(event)">
            <div class="upload-placeholder" id="upload-msg">
                <svg class="icon" style="width:48px; height:48px; color:var(--primary); margin-bottom:10px;" viewBox="0 0 24 24"><path d="M3 4V1h2v3h3v2H5v3H3V6H0V4h3zm3 6V7h3V4h7l1.83 2H21c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V10h3zm7 9c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm0-8c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z"/></svg>
                <p><strong>é»æ“Šæ‹ç…§ / ä¸Šå‚³ç…§ç‰‡</strong></p>
                <p style="font-size:0.9rem; margin-top:5px;">æˆ–ç›´æ¥é»æ“Šä¸‹æ–¹æŒ‰éˆ•é€²è¡Œã€Œéš¨æ©Ÿæ¨¡æ“¬åˆ†æã€</p>
            </div>
            <img id="preview" class="preview-img" alt="Food Preview">
        </div>
        
        <div id="control-panel" style="margin-top: 20px;">
            <button id="analyze-btn" class="btn btn-primary" onclick="app.startAnalysis()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 13.17l7.59-7.59L19 7l-9 10z"/></svg>
                é–‹å§‹ VLM åˆ†æ (AI è‡ªå‹•è­˜åˆ¥)
            </button>
            <p style="text-align:center; font-size:0.85rem; color:#888; margin-top:10px;">
                *è‹¥æœªä¸Šå‚³ç…§ç‰‡ï¼ŒAI å°‡æœƒéš¨æ©Ÿæ¨¡æ“¬ä¸€ç¨®é£Ÿç‰©æƒ…å¢ƒã€‚
            </p>
        </div>
    </div>

    <div id="result-section" class="card">
        <div class="result-header flex-between">
            <div>
                <div class="food-name" id="res-food-name">--</div>
                <div class="confidence" id="res-confidence">AI ä¿¡å¿ƒåº¦: --%</div>
            </div>
            <div id="res-badge" class="status-badge bg-green">--</div>
        </div>

        <div class="section-title">è­˜åˆ¥å…§å®¹èˆ‡ä»½é‡</div>
        <div class="grid-2">
            <div>
                <small style="color:#666;">å…§å®¹ç‰©æˆåˆ†ï¼š</small>
                <div id="res-ingredients" class="chip-container" style="margin-top:5px;"></div>
            </div>
            <div>
                <small style="color:#666;">ä¼°è¨ˆä»½é‡ï¼š</small>
                <div style="font-size:1.1rem; font-weight:bold; margin-top:5px;">
                    <span id="res-size">--</span> 
                    <span style="font-size:0.9rem; color:#666;" id="res-grams">(--g)</span>
                </div>
                <div id="res-texture" style="font-size:0.85rem; color:#888; margin-top:5px;"></div>
            </div>
        </div>

        <div class="section-title">ç‡Ÿé¤Šæˆåˆ†åˆ†æ (æ¯ä»½)</div>
        <div id="nutrition-chart">
            </div>

        <div class="section-title">è‡¨åºŠå€‹äººåŒ–å»ºè­°</div>
        <div id="res-recommendation-box" class="recommendation-box rec-safe">
            <h4 id="res-decision" style="margin-bottom:10px;">å»ºè­°é£Ÿç”¨</h4>
            <ul id="res-advices" class="advice-list"></ul>
            
            <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
                <strong>ğŸ’¡ æ›¿ä»£æ–¹æ¡ˆ / æ”¹é€²å»ºè­°ï¼š</strong>
                <ul id="res-alternatives" class="advice-list" style="margin-top:5px;"></ul>
            </div>
        </div>

        <div class="flex-gap" style="margin-top: 20px;">
            <button class="btn btn-outline btn-sm" onclick="app.copyReport()">è¤‡è£½å ±å‘Šæ–‡å­—</button>
        </div>
    </div>

    <div class="card">
        <div class="section-title" style="margin-top:0;">æ­·å²ç´€éŒ„ (LocalStorage)</div>
        <div id="history-list">
            <div style="text-align:center; color:#999; padding:20px;">å°šç„¡ç´€éŒ„</div>
        </div>
    </div>

</div>

<div id="loading" class="loading-overlay">
    <div class="spinner"></div>
    <h3>AI è¦–è¦ºåˆ†æä¸­...</h3>
    <p style="color:#666;" id="loading-text">æ­£åœ¨åˆ†æå½±åƒç‰¹å¾µ...</p>
</div>

<script>
/**
 * ç‡Ÿé¤Šé£²é£Ÿ VLM Demo - å‰ç«¯é‚è¼¯æ ¸å¿ƒ
 * ä½œè€…ï¼šAI Assistant
 */

// --- 1. è³‡æ–™æ¨¡æ“¬ (Mock Data) ---

// ç—…äººè³‡æ–™åº«
const PATIENTS = [
    {
        id: 1,
        name: "ç‹å°æ˜ (Wang)",
        age: 56, gender: "ç”·", height: 172, weight: 78,
        diseases: ["ç¬¬2å‹ç³–å°¿ç—… (T2DM)", "é«˜è¡€å£“ (HTN)"],
        meds: ["Metformin", "Amlodipine"],
        allergies: ["ç„¡"],
        goal: "åš´æ ¼æ§ç³–ã€æ¸›é‡",
        conditions: { dm: true, htn: true, ckd: false, dysphagia: false, stomach: false }
    },
    {
        id: 2,
        name: "æ—ç¾ç² (Lin)",
        age: 68, gender: "å¥³", height: 155, weight: 52,
        diseases: ["æ…¢æ€§è…è‡Ÿç—… (CKD Stage 3)", "ç—›é¢¨"],
        meds: ["åˆ©å°¿åŠ‘", "é™å°¿é…¸è—¥"],
        allergies: ["æµ·é®® (Seafood)"],
        goal: "ä½éˆ‰ã€ä½é‰€ã€ä½ç£·",
        conditions: { dm: false, htn: true, ckd: true, dysphagia: false, stomach: false }
    },
    {
        id: 3,
        name: "é™³å¤§å‰ (Chen)",
        age: 75, gender: "ç”·", height: 165, weight: 60,
        diseases: ["ä¸­é¢¨å¾Œååš¥éšœç¤™", "èƒƒé£Ÿé“é€†æµ (GERD)"],
        meds: ["æŠ—å‡è¡€åŠ‘", "PPI èƒƒè—¥"],
        allergies: ["èŠ±ç”Ÿ (Peanuts)"],
        goal: "é é˜²å—†å’³ã€é¿å…åˆºæ¿€æ€§é£Ÿç‰©",
        conditions: { dm: false, htn: false, ckd: false, dysphagia: true, stomach: true }
    }
];

// é£Ÿç‰©è³‡æ–™åº« (VLM çŸ¥è­˜åº«)
const FOOD_DB = {
    bento: {
        name: "å°å¼æ’éª¨ä¾¿ç•¶",
        ingredients: ["ç™½é£¯", "ç‚¸æ’éª¨", "æ»·è›‹", "é«˜éº—èœ", "è±†å¹²", "é…¸èœ"],
        portion: { size: "Large", grams: 550 },
        nutrition: { calories: 850, carbs: 105, protein: 35, fat: 38, sugar: 8, sodium: 1200, potassium: 400, phosphorus: 300 },
        texture: "IDDSI 7 (Regular) - æ··åˆè³ªåœ°",
        tags: ["high_sodium", "high_carb", "fried"]
    },
    beef_noodle: {
        name: "ç´…ç‡’ç‰›è‚‰éºµ",
        ingredients: ["éºµæ¢", "ç‰›è…±è‚‰", "ç´…ç‡’æ¹¯é ­", "é’æ±Ÿèœ", "é…¸èœ", "è”¥èŠ±"],
        portion: { size: "Large", grams: 700 },
        nutrition: { calories: 750, carbs: 85, protein: 45, fat: 28, sugar: 5, sodium: 2400, potassium: 500, phosphorus: 350 },
        texture: "IDDSI 6 (Soft & Bite-Sized) - è‹¥è‚‰ç‡‰çˆ›",
        tags: ["high_sodium", "soup"]
    },
    pork_rice: {
        name: "æ»·è‚‰é£¯ + ç‡™é’èœ",
        ingredients: ["ç™½é£¯", "æ»·è‚‰ç‡¥", "é†¬æ²¹", "è±¬æ²¹", "ç‡™ç©ºå¿ƒèœ"],
        portion: { size: "Medium", grams: 350 },
        nutrition: { calories: 550, carbs: 65, protein: 15, fat: 25, sugar: 6, sodium: 900, potassium: 250, phosphorus: 150 },
        texture: "IDDSI 7 (Regular)",
        tags: ["high_fat", "high_sodium"]
    },
    salad: {
        name: "é›è‚‰å‡±è–©æ²™æ‹‰",
        ingredients: ["è˜¿ç¾ç”Ÿèœ", "é›èƒ¸è‚‰", "éºµåŒ…ä¸", "èµ·å¸ç²‰", "å‡±è–©é†¬"],
        portion: { size: "Medium", grams: 280 },
        nutrition: { calories: 350, carbs: 15, protein: 28, fat: 22, sugar: 3, sodium: 600, potassium: 450, phosphorus: 200 },
        texture: "IDDSI 7 (Regular) - ç”Ÿèœçº–ç¶­ç²—",
        tags: ["raw", "healthy_option"]
    },
    fried_chicken: {
        name: "ç‚¸é›æ’",
        ingredients: ["é›èƒ¸è‚‰", "ç‚¸ç²‰", "èƒ¡æ¤’é¹½", "é£Ÿç”¨æ²¹"],
        portion: { size: "Large", grams: 300 },
        nutrition: { calories: 650, carbs: 40, protein: 35, fat: 38, sugar: 1, sodium: 1100, potassium: 300, phosphorus: 250 },
        texture: "IDDSI 7 (Regular) - ç¡¬è„†å¤–çš®",
        tags: ["fried", "high_fat", "high_sodium"]
    },
    burger: {
        name: "é›™å±¤ç‰›è‚‰èµ·å¸æ¼¢å ¡",
        ingredients: ["æ¼¢å ¡éºµåŒ…", "ç‰›è‚‰æ¼¢å ¡æ’", "èµ·å¸ç‰‡", "é…¸é»ƒç“œ", "ç•ªèŒ„é†¬", "èŠ¥æœ«"],
        portion: { size: "Medium", grams: 320 },
        nutrition: { calories: 680, carbs: 45, protein: 32, fat: 40, sugar: 9, sodium: 1350, potassium: 350, phosphorus: 400 },
        texture: "IDDSI 7 (Regular)",
        tags: ["high_sodium", "high_fat", "processed"]
    },
    bubble_tea: {
        name: "çç å¥¶èŒ¶ (å…¨ç³–)",
        ingredients: ["ç´…èŒ¶", "å¥¶ç²¾ç²‰", "æœç³–", "çç (æ¨¹è–¯ç²‰)", "å†°å¡Š"],
        portion: { size: "Large (700ml)", grams: 700 },
        nutrition: { calories: 650, carbs: 90, protein: 2, fat: 30, sugar: 65, sodium: 50, potassium: 80, phosphorus: 100 },
        texture: "IDDSI 2 (Mildly Thick) + å›ºé«”çç  (çª’æ¯é¢¨éšª)",
        tags: ["high_sugar", "liquid_calorie", "choking_hazard"]
    },
    fruit: {
        name: "ç¶œåˆæ°´æœæ‹¼ç›¤",
        ingredients: ["è¥¿ç“œ", "èŠ­æ¨‚", "é³³æ¢¨", "å°ç•ªèŒ„"],
        portion: { size: "Medium", grams: 300 },
        nutrition: { calories: 150, carbs: 38, protein: 2, fat: 0.5, sugar: 28, sodium: 5, potassium: 450, phosphorus: 30 },
        texture: "IDDSI 7 (Regular) - éƒ¨åˆ†ç¡¬è³ª",
        tags: ["high_potassium", "high_sugar_natural"]
    },
    packaged: {
        name: "èŠ±ç”Ÿå¤¾å¿ƒé¤…ä¹¾",
        ingredients: ["éºµç²‰", "èŠ±ç”Ÿé†¬", "æ£•æ«šæ²¹", "ç³–", "å¥¶ç²‰"],
        portion: { size: "Small (1 pack)", grams: 80 },
        nutrition: { calories: 400, carbs: 50, protein: 8, fat: 20, sugar: 25, sodium: 300, potassium: 120, phosphorus: 100 },
        texture: "IDDSI 7 (Regular) - æ˜“ç¢å±‘",
        tags: ["allergen_peanut", "allergen_milk", "processed"]
    }
};

// --- 2. æ‡‰ç”¨ç¨‹å¼é‚è¼¯ (Application Logic) ---

const app = {
    currentPatientIndex: 0,
    selectedFile: null,
    
    init: function() {
        this.renderPatient();
        this.loadHistory();
    },

    // åˆ‡æ›ç—…äºº
    switchPatient: function() {
        this.currentPatientIndex = (this.currentPatientIndex + 1) % PATIENTS.length;
        this.renderPatient();
        // å¦‚æœå·²ç¶“æœ‰åˆ†æçµæœï¼Œé‡æ–°åˆ†æä¸€æ¬¡ä»¥æ›´æ–°å»ºè­°
        const resultSection = document.getElementById('result-section');
        if (resultSection.style.display === 'block') {
            this.startAnalysis(true); // true = silent reload
        }
    },

    renderPatient: function() {
        const p = PATIENTS[this.currentPatientIndex];
        const bmi = (p.weight / ((p.height/100) ** 2)).toFixed(1);
        
        document.getElementById('p-name').textContent = p.name;
        document.getElementById('p-basic').textContent = `${p.age}æ­² / ${p.gender} / ${p.height}cm / ${p.weight}kg`;
        document.getElementById('p-bmi').textContent = bmi;
        
        // Helper to render tags
        const renderTags = (arr, cls, target) => {
            const html = arr.map(item => `<span class="tag ${cls}">${item}</span>`).join('');
            document.getElementById(target).innerHTML = html;
        };

        renderTags(p.diseases, 'tag-disease', 'p-diseases');
        renderTags(p.meds, 'tag-med', 'p-meds');
        renderTags(p.allergies, 'tag-allergy', 'p-allergies');
        document.getElementById('p-goal').textContent = p.goal;
    },

    handleFileSelect: function(event) {
        const file = event.target.files[0];
        if (file) {
            this.selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.getElementById('preview');
                const uploadMsg = document.getElementById('upload-msg');
                img.src = e.target.result;
                img.style.display = 'block';
                uploadMsg.style.display = 'none'; // Hide text placeholder
                document.getElementById('drop-zone').style.borderColor = '#ccc';
            };
            reader.readAsDataURL(file);
        }
    },

    resetDemo: function() {
        this.selectedFile = null;
        document.getElementById('file-input').value = '';
        document.getElementById('preview').style.display = 'none';
        document.getElementById('upload-msg').style.display = 'block'; // Show placeholder
        document.getElementById('result-section').style.display = 'none';
        window.scrollTo(0,0);
    },

    // æ ¸å¿ƒï¼šæ¨¡æ“¬ AI åˆ†æ
    mockAnalyze: function(foodKey, patient) {
        const food = FOOD_DB[foodKey];
        const res = { ...food }; // Clone
        res.warnings = [];
        res.recommendations = [];
        res.alternatives = [];
        res.decision = "Recommend"; // Default
        res.confidence = 88 + Math.floor(Math.random() * 11); // 88-99%

        // è¦å‰‡å¼•æ“ (Rule Engine)
        const cond = patient.conditions;
        const nut = food.nutrition;
        
        // 1. éæ•æª¢æŸ¥ (Highest Priority)
        const allergens = { "èŠ±ç”Ÿ": "peanut", "æµ·é®®": "seafood", "ç‰›å¥¶": "milk" };
        patient.allergies.forEach(allergy => {
            for (let [k, v] of Object.entries(allergens)) {
                if (allergy.includes(k) && (food.tags.includes(`allergen_${v}`) || food.ingredients.some(i => i.includes(k)))) {
                    res.warnings.push(`âš ï¸ åš´é‡è­¦ç¤ºï¼šé£Ÿç‰©å«æœ‰ã€Œ${k}ã€æˆåˆ†ï¼Œæ‚¨å°æ­¤éæ•ï¼`);
                    res.decision = "Avoid";
                }
            }
        });

        // 2. CKD è…è‡Ÿç—…è¦å‰‡
        if (cond.ckd) {
            if (nut.sodium > 600) {
                res.warnings.push("âš ï¸ éˆ‰å«é‡éé«˜ (å»ºè­°å–®é¤<600mg)ï¼Œå¯èƒ½å°è‡´æ°´è…«æˆ–é«˜è¡€å£“ã€‚");
                res.recommendations.push("è«‹å‹¿å–æ¹¯ï¼Œæˆ–æ¸›å°‘é†¬æ–™ä½¿ç”¨ã€‚");
                res.decision = res.decision === "Avoid" ? "Avoid" : "Caution";
            }
            if (nut.potassium > 400 || food.tags.includes("high_potassium")) {
                res.warnings.push("âš ï¸ é‰€é›¢å­åé«˜ï¼Œéœ€æ³¨æ„æ°´æœæˆ–ç”Ÿèœä»½é‡ã€‚");
                res.alternatives.push("è”¬èœå»ºè­°ç‡™éå†åƒ (å»é™¤é‰€é›¢å­)ã€‚");
            }
            if (nut.protein > 30) {
                res.warnings.push("âš ï¸ è›‹ç™½è³ªå«é‡è¼ƒé«˜ï¼Œè«‹ä¾é†«å›‘æ§åˆ¶ç¸½é‡ã€‚");
            }
        }

        // 3. DM ç³–å°¿ç—…è¦å‰‡
        if (cond.dm) {
            if (nut.sugar > 10 || food.tags.includes("high_sugar")) {
                res.warnings.push(`âš ï¸ å«ç³–é‡é«˜ (${nut.sugar}g)ï¼Œå®¹æ˜“å¼•èµ·è¡€ç³–é£†å‡ã€‚`);
                res.decision = "Avoid";
                res.alternatives.push("æ”¹é¸ç„¡ç³–èŒ¶é£²æˆ–ä»£ç³–é£²æ–™ã€‚");
            }
            if (nut.carbs > 80) {
                res.warnings.push("âš ï¸ ç¢³æ°´åŒ–åˆç‰©è¶…æ¨™ï¼Œå»ºè­°é£¯é‡æ¸›åŠã€‚");
                res.recommendations.push("å„ªå…ˆæ”å–è”¬èœèˆ‡è›‹ç™½è³ªï¼Œæœ€å¾Œåƒé£¯ã€‚");
                res.decision = res.decision === "Avoid" ? "Avoid" : "Caution";
            }
        }

        // 4. HF å¿ƒè¡°ç«­ / é«˜è¡€å£“
        if (cond.htn || cond.hf) {
            if (nut.sodium > 800) {
                res.warnings.push("âš ï¸ é«˜éˆ‰å±éšªï¼å¯èƒ½åŠ é‡å¿ƒè‡Ÿè² æ“”ã€‚");
                res.decision = res.decision === "Avoid" ? "Avoid" : "Caution";
                res.alternatives.push("é¸æ“‡æ¸…è’¸æˆ–çƒ¤çš„çƒ¹èª¿æ–¹å¼ï¼Œé¿å…æ»·/ç‚¸ã€‚");
            }
        }

        // 5. ååš¥éšœç¤™
        if (cond.dysphagia) {
            if (food.tags.includes("choking_hazard")) {
                res.warnings.push("âš ï¸ çª’æ¯é¢¨éšªï¼šå«æœ‰å›ºé«”é¡†ç²’ (å¦‚çç )ã€‚");
                res.decision = "Avoid";
            } else if (food.texture.includes("Regular") || food.texture.includes("Hard")) {
                res.warnings.push("âš ï¸ è³ªåœ°éç¡¬æˆ–çº–ç¶­éå¤šï¼Œä¸æ˜“ååš¥ã€‚");
                res.recommendations.push("å»ºè­°ä½¿ç”¨é£Ÿç‰©èª¿ç†æ©Ÿæ‰“æˆæ³¥ç‹€ (IDDSI 4)ã€‚");
                res.recommendations.push("æˆ–æ·»åŠ å¢ç¨ åŠ‘èª¿æ•´æ¶²é«”é»ç¨ åº¦ã€‚");
                res.decision = res.decision === "Avoid" ? "Avoid" : "Caution";
            }
        }

        // 6. èƒƒç—…
        if (cond.stomach) {
            if (food.tags.includes("fried") || food.tags.includes("high_fat")) {
                res.warnings.push("âš ï¸ æ²¹ç‚¸/é«˜è„‚é£Ÿç‰©æ˜“å»¶ç·©èƒƒæ’ç©ºï¼Œå¼•ç™¼ä¸é©ã€‚");
                res.decision = res.decision === "Avoid" ? "Avoid" : "Caution";
                res.alternatives.push("å»é™¤ç‚¸çš®æˆ–æ”¹åƒç™½é£¯/ç˜¦è‚‰ã€‚");
            }
        }

        // é è¨­å»ºè­°
        if (res.warnings.length === 0) {
            res.recommendations.push("æ­¤é¤é»ç¬¦åˆæ‚¨çš„é£²é£ŸåŸå‰‡ï¼Œè«‹å®‰å¿ƒé£Ÿç”¨ã€‚");
            res.recommendations.push("è¨˜å¾—ç´°åš¼æ…¢åš¥ï¼Œä¿æŒæ°´åˆ†æ”å–ã€‚");
        }
        if (res.alternatives.length === 0) {
            res.alternatives.push("æ­é…ä¸€ä»½ç‡™é’èœå¢åŠ çº–ç¶­ã€‚");
        }

        return res;
    },

    startAnalysis: function(isSilent = false) {
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        
        if (!isSilent) {
            loading.style.display = 'flex';
            window.scrollTo(0,0);
            
            // æ ¹æ“šæœ‰ç„¡ç…§ç‰‡é¡¯ç¤ºä¸åŒ Loading æ–‡å­—
            if (this.selectedFile) {
                loadingText.textContent = "æ­£åœ¨æƒæå½±åƒç‰¹å¾µ...";
                setTimeout(() => { loadingText.textContent = "æ­£åœ¨ä¼°ç®—é£Ÿç‰©é«”ç©èˆ‡é‡é‡..."; }, 1000);
            } else {
                loadingText.textContent = "æ­£åœ¨æ¨¡æ“¬ VLM å ´æ™¯è¼¸å…¥...";
                setTimeout(() => { loadingText.textContent = "æ¨¡æ“¬è³‡æ–™ç”Ÿæˆä¸­..."; }, 1000);
            }
            setTimeout(() => { loadingText.textContent = "æ­£åœ¨æ¯”å°å€‹äººç—…æ­·èˆ‡ç”¨è—¥ç¦å¿Œ..."; }, 1800);
        }

        setTimeout(() => {
            let foodKey;
            
            // æ ¸å¿ƒé‚è¼¯ä¿®æ”¹ï¼š
            // 1. å¦‚æœæœ‰ä¸Šå‚³æª”æ¡ˆ -> ç”¨æª”å hash æ±ºå®š (å›ºå®šçµæœ)
            // 2. å¦‚æœæ²’æª”æ¡ˆ -> ç´”éš¨æ©Ÿæ±ºå®š (æ¨¡æ“¬)
            const keys = Object.keys(FOOD_DB);
            
            if (this.selectedFile) {
                const name = this.selectedFile.name;
                let hash = 0;
                for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
                foodKey = keys[Math.abs(hash) % keys.length];
            } else {
                // ç´”éš¨æ©Ÿ
                foodKey = keys[Math.floor(Math.random() * keys.length)];
            }

            const patient = PATIENTS[this.currentPatientIndex];
            const result = this.mockAnalyze(foodKey, patient);

            this.renderResult(result);
            if (!isSilent) {
                loading.style.display = 'none';
                this.saveHistory(result, patient);
            }
        }, isSilent ? 0 : 2500);
    },

    renderResult: function(data) {
        const section = document.getElementById('result-section');
        section.style.display = 'block';

        // 1. Basic Info
        document.getElementById('res-food-name').textContent = data.name;
        document.getElementById('res-confidence').textContent = `AI ä¿¡å¿ƒåº¦: ${data.confidence}%`;
        
        // Ingredients
        const ingContainer = document.getElementById('res-ingredients');
        ingContainer.innerHTML = data.ingredients.map(i => `<span class="chip">${i}</span>`).join('');

        // Portion & Texture
        document.getElementById('res-size').textContent = data.portion.size;
        document.getElementById('res-grams').textContent = `(ç´„ ${data.portion.grams}g)`;
        document.getElementById('res-texture').textContent = `è³ªåœ°åˆ†æ: ${data.texture}`;

        // 2. Nutrition Chart
        const createBar = (label, val, unit, max, isBad = false) => {
            const pct = Math.min((val / max) * 100, 100);
            let colorClass = "";
            if (isBad && pct > 80) colorClass = "bar-danger";
            else if (isBad && pct > 50) colorClass = "bar-warn";
            
            return `
            <div class="nutrition-row">
                <div>${label}</div>
                <div class="progress-bg"><div class="progress-fill ${colorClass}" style="width: ${pct}%"></div></div>
                <div style="text-align:right; font-weight:bold; ${colorClass ? 'color:var(--danger)' : ''}">${val}${unit}</div>
            </div>`;
        };

        const nut = data.nutrition;
        let chartHtml = "";
        chartHtml += createBar("ç†±é‡", nut.calories, "kcal", 1000);
        chartHtml += createBar("ç¢³æ°´", nut.carbs, "g", 120, true);
        chartHtml += createBar("è›‹ç™½è³ª", nut.protein, "g", 50);
        chartHtml += createBar("è„‚è‚ª", nut.fat, "g", 50, true);
        chartHtml += createBar("ç³–", nut.sugar, "g", 30, true);
        chartHtml += createBar("éˆ‰", nut.sodium, "mg", 2000, true);
        document.getElementById('nutrition-chart').innerHTML = chartHtml;
        
        // Trigger reflow for animation
        setTimeout(() => {
            document.querySelectorAll('.progress-fill').forEach(el => {
                // re-apply width to force transition
                const target = el.style.width;
                el.style.width = '0%';
                setTimeout(() => el.style.width = target, 50);
            });
        }, 100);

        // 3. Recommendation Box
        const box = document.getElementById('res-recommendation-box');
        const badge = document.getElementById('res-badge');
        const decisionTitle = document.getElementById('res-decision');

        // Styles reset
        box.className = "recommendation-box";
        badge.className = "status-badge";

        if (data.decision === "Avoid") {
            box.classList.add("rec-danger");
            badge.classList.add("bg-red");
            badge.textContent = "ä¸å»ºè­°é£Ÿç”¨";
            decisionTitle.textContent = "âš ï¸ ä¸å»ºè­°é£Ÿç”¨ (High Risk)";
            decisionTitle.style.color = "var(--danger)";
        } else if (data.decision === "Caution") {
            box.classList.add("rec-warn");
            badge.classList.add("bg-orange");
            badge.textContent = "è¬¹æ…é£Ÿç”¨";
            decisionTitle.textContent = "âš ï¸ è¬¹æ…é£Ÿç”¨ (Caution)";
            decisionTitle.style.color = "#e65100";
        } else {
            box.classList.add("rec-safe");
            badge.classList.add("bg-green");
            badge.textContent = "æ¨è–¦é£Ÿç”¨";
            decisionTitle.textContent = "âœ… æ¨è–¦é£Ÿç”¨ (Safe)";
            decisionTitle.style.color = "var(--success)";
        }

        // List items
        const renderList = (arr, elId) => {
            document.getElementById(elId).innerHTML = arr.map(item => `<li>${item}</li>`).join('');
        };

        const allAdvices = [...data.warnings, ...data.recommendations];
        renderList(allAdvices, 'res-advices');
        renderList(data.alternatives, 'res-alternatives');
        
        // Scroll to result
        if (window.innerWidth < 600) {
            section.scrollIntoView({ behavior: 'smooth' });
        }
    },

    saveHistory: function(data, patient) {
        const record = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            patient: patient.name,
            food: data.name,
            calories: data.nutrition.calories,
            decision: data.decision
        };
        
        let history = JSON.parse(localStorage.getItem('vlm_history') || '[]');
        history.unshift(record); // Add to top
        localStorage.setItem('vlm_history', JSON.stringify(history));
        this.loadHistory();
    },

    loadHistory: function() {
        const list = document.getElementById('history-list');
        const history = JSON.parse(localStorage.getItem('vlm_history') || '[]');
        
        if (history.length === 0) return;

        list.innerHTML = history.map(item => {
            let color = item.decision === "Avoid" ? "red" : (item.decision === "Caution" ? "orange" : "green");
            return `
            <div class="history-item">
                <div style="width:10px; height:10px; border-radius:50%; background:${color};"></div>
                <div>
                    <div class="history-food">${item.food} <small style="font-weight:normal">(${item.calories} kcal)</small></div>
                    <div class="history-date">${item.date} â€¢ ${item.patient}</div>
                </div>
                <div style="font-size:0.8rem; font-weight:bold; color:${color}">${item.decision}</div>
            </div>`;
        }).join('');
    },

    copyReport: function() {
        const food = document.getElementById('res-food-name').innerText;
        const decision = document.getElementById('res-decision').innerText;
        const advices = Array.from(document.querySelectorAll('#res-advices li')).map(li => "â€¢ " + li.innerText).join('\n');
        
        const text = `ã€AI ç‡Ÿé¤Šé£²é£Ÿè©•ä¼°å ±å‘Šã€‘\né£Ÿç‰©ï¼š${food}\nè©•ä¼°çµæœï¼š${decision}\n\nå»ºè­°äº‹é …ï¼š\n${advices}`;
        
        navigator.clipboard.writeText(text).then(() => {
            alert("å ±å‘Šå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
        });
    }
};

// Initialize
window.onload = () => app.init();

</script>
</body>
</html>