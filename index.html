<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‡Ÿé¤Šé£²é£Ÿ VLM ç³»çµ±</title>
    <style>
        :root {
            --primary: #009688;
            --primary-dark: #00796b;
            --secondary: #2196f3;
            --accent: #ff9800;
            --danger: #f44336;
            --success: #4caf50;
            --bg: #f0f2f5;
            --surface: #ffffff;
            --text-main: #333333;
            --text-sub: #666666;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text-main); padding-bottom: 30px; min-height: 100vh; }
        
        /* Layout & Container */
        .container { max-width: 600px; margin: 0 auto; padding: 20px; position: relative; }
        .view { display: none; animation: fadeIn 0.3s ease-out; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Header */
        header { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; margin-bottom: 20px; }
        .app-title { font-size: 1.4rem; font-weight: 800; color: var(--primary-dark); display: flex; align-items: center; gap: 8px; }
        .current-patient-badge { font-size: 0.85rem; background: #e0f2f1; color: var(--primary-dark); padding: 4px 12px; border-radius: 20px; font-weight: 600; }

        /* Dashboard (Home) Grid */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .dash-card { background: var(--surface); border-radius: var(--radius); padding: 25px 15px; text-align: center; box-shadow: var(--shadow); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 160px; }
        .dash-card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.12); border-color: var(--primary); }
        .dash-icon { width: 48px; height: 48px; margin-bottom: 12px; color: var(--primary); }
        .dash-title { font-size: 1.1rem; font-weight: bold; color: var(--text-main); }

        /* Common Components */
        .card { background: var(--surface); border-radius: var(--radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--shadow); }
        .btn { border: none; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; transition: 0.2s; width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: #e0f7fa; color: var(--primary-dark); }
        .btn-back { width: auto; background: transparent; color: var(--text-sub); padding: 8px; margin-bottom: 10px; justify-content: flex-start; }
        .btn-back:hover { color: var(--primary); }

        /* Sub-page Specifics */
        .section-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        /* Upload Area */
        .upload-area { border: 2px dashed #ccc; border-radius: var(--radius); padding: 40px 20px; text-align: center; cursor: pointer; background: #fafafa; position: relative; transition: 0.2s; }
        .upload-area:hover { border-color: var(--primary); background: #f0fdfc; }
        .upload-area input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor: pointer; }
        .preview-img { max-width: 100%; max-height: 250px; border-radius: 8px; margin: 15px auto; display: none; object-fit: cover; }

        /* Result Styles */
        .nutrition-row { display: grid; grid-template-columns: 70px 1fr 60px; align-items: center; margin-bottom: 8px; font-size: 0.9rem; }
        .progress-bg { background: #eee; height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--secondary); width: 0%; transition: width 1s; }
        .warn-text { color: var(--danger); font-weight: bold; }
        
        .recommendation-box { background: #e8f5e9; border: 1px solid #c8e6c9; padding: 15px; border-radius: 10px; margin-top: 15px; }
        .recommendation-box.danger { background: #ffebee; border-color: #ffcdd2; }
        .recommendation-box.warn { background: #fff3e0; border-color: #ffe0b2; }

        /* Log List */
        .log-item { display: grid; grid-template-columns: 50px 1fr auto; gap: 12px; padding: 12px; border-bottom: 1px solid #eee; align-items: center; }
        .log-icon { width: 40px; height: 40px; background: #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }

        /* Profile Tags */
        .tag-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 5px; }
        .tag { font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; background: #eee; color: #555; }
        .tag.blue { background: #e3f2fd; color: #1565c0; }
        .tag.red { background: #ffebee; color: #c62828; }

        /* Loading */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; display: none; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="app-title">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 2h1.5v3l2.5-1.5L18.5 8 16 9.5V11h-4V5zm-2 14H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm-4 8H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2z"/></svg>
            NutriAI
        </div>
        <div class="current-patient-badge" id="header-patient-name">è¼‰å…¥ä¸­...</div>
    </header>

    <div id="view-home" class="view active">
        <div style="margin-bottom: 20px; text-align: center; color: #666;">
            <p>æ­¡è¿ä½¿ç”¨ AI ç‡Ÿé¤Šè¼”åŠ©ç³»çµ±</p>
            <p style="font-size: 0.9rem;">è«‹é¸æ“‡ä¸‹æ–¹åŠŸèƒ½é–‹å§‹ä½¿ç”¨</p>
        </div>
        
        <div class="dashboard-grid">
            <div class="dash-card" onclick="app.navTo('view-upload')">
                <svg class="dash-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 11.5V13H9v2.5L5.5 12 9 8.5V11h6V8.5l3.5 3.5-3.5 3.5z"/></svg>
                <div class="dash-title">æ‹ç…§åŠä¸Šå‚³</div>
            </div>

            <div class="dash-card" onclick="app.navTo('view-profile')">
                <svg class="dash-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                <div class="dash-title">å€‹äººç—…æ­·</div>
            </div>

            <div class="dash-card" onclick="app.navTo('view-log')">
                <svg class="dash-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 4h2v2h-2V6zm0 4h2v2h-2v-2zm0 4h2v2h-2v-2zm6 2h-4v-2h4v2zm0-4h-4v-2h4v2zm0-4h-4V6h4v2z"/></svg>
                <div class="dash-title">é£²é£Ÿæ—¥èªŒ</div>
            </div>

            <div class="dash-card" onclick="app.navTo('view-advice')">
                <svg class="dash-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6C7.8 12.16 7 10.63 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg>
                <div class="dash-title">é£²é£Ÿå»ºè­°</div>
            </div>
        </div>
    </div>

    <div id="view-upload" class="view">
        <button class="btn btn-back" onclick="app.navTo('view-home')">â† è¿”å›é¦–é </button>
        <div class="section-title">æ‹ç…§ / ä¸Šå‚³èˆ‡åˆ†æ</div>

        <div class="card">
            <div class="upload-area" id="drop-zone">
                <input type="file" id="file-input" accept="image/*" onchange="app.handleFileSelect(event)">
                <div id="upload-placeholder">
                    <svg style="width:40px;height:40px;color:#ccc" viewBox="0 0 24 24" fill="currentColor"><path d="M3 4V1h2v3h3v2H5v3H3V6H0V4h3zm3 6V7h3V4h7l1.83 2H21c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V10h3zm7 9c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm0-8c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z"/></svg>
                    <p style="margin-top:10px; color:#666;"><strong>é»æ“Šæ‹ç…§æˆ–ä¸Šå‚³</strong></p>
                    <small>æˆ–ç›´æ¥é»æ“Šä¸‹æ–¹åˆ†ææŒ‰éˆ•é€²è¡Œéš¨æ©Ÿæ¨¡æ“¬</small>
                </div>
                <img id="preview" class="preview-img">
            </div>
            
            <button class="btn btn-primary" style="margin-top:15px;" onclick="app.startAnalysis()">
                é–‹å§‹ VLM åˆ†æ
            </button>
        </div>

        <div id="result-section" style="display:none;">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 id="res-food-name">--</h2>
                    <span id="res-badge" style="padding:4px 10px; border-radius:15px; background:#eee; font-size:0.8rem; font-weight:bold;">--</span>
                </div>
                <p style="color:#666; font-size:0.9rem; margin:5px 0;">AI ä¿¡å¿ƒåº¦: <span id="res-confidence">--%</span></p>
                <div id="res-ingredients" class="tag-container" style="margin-bottom:15px;"></div>

                <div class="section-title" style="font-size:1rem; margin-top:15px;">ç‡Ÿé¤Šä¼°ç®—</div>
                <div id="nutrition-chart"></div>

                <div id="res-advice-box" class="recommendation-box">
                    <strong>ğŸ©º AI è‡¨åºŠå»ºè­°ï¼š</strong>
                    <ul id="res-advices" style="padding-left:20px; margin-top:8px; font-size:0.95rem;"></ul>
                </div>

                <button class="btn btn-secondary" style="margin-top:15px;" onclick="app.navTo('view-log')">æŸ¥çœ‹æ—¥èªŒ</button>
            </div>
        </div>
    </div>

    <div id="view-profile" class="view">
        <button class="btn btn-back" onclick="app.navTo('view-home')">â† è¿”å›é¦–é </button>
        <div class="section-title">å€‹äººç—…æ­·è³‡æ–™</div>

        <div class="card" style="border-left: 5px solid var(--primary);">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <div>
                    <h2 id="p-name">--</h2>
                    <p style="color:#666;" id="p-details">--</p>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:0.8rem; color:#888;">BMI</div>
                    <strong style="font-size:1.4rem;" id="p-bmi">--</strong>
                </div>
            </div>
            
            <div style="margin-top:20px;">
                <p style="font-size:0.9rem; color:#666;">è¨ºæ–·/ç–¾ç—…</p>
                <div id="p-diseases" class="tag-container"></div>
            </div>
            <div style="margin-top:10px;">
                <p style="font-size:0.9rem; color:#666;">é•·æœŸç”¨è—¥</p>
                <div id="p-meds" class="tag-container"></div>
            </div>
            <div style="margin-top:10px;">
                <p style="font-size:0.9rem; color:#666;">éæ•åŸ</p>
                <div id="p-allergies" class="tag-container"></div>
            </div>
        </div>

        <div class="card">
            <h3 style="font-size:1.1rem; margin-bottom:10px;">å¥åº·ç›®æ¨™</h3>
            <p id="p-goal" style="color:var(--primary-dark); font-weight:bold;">--</p>
        </div>

        <button class="btn btn-secondary" onclick="app.switchPatient()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="margin-right:5px;"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
            åˆ‡æ›ä¸‹ä¸€ä½ç—…äºº (Demo)
        </button>
    </div>

    <div id="view-log" class="view">
        <button class="btn btn-back" onclick="app.navTo('view-home')">â† è¿”å›é¦–é </button>
        <div class="section-title">é£²é£Ÿæ—¥èªŒ</div>
        
        <div class="card" style="padding:0; overflow:hidden;">
            <div id="log-list">
                </div>
        </div>
        <div style="text-align:center; padding:10px;">
            <button class="btn btn-outline" style="font-size:0.8rem; color:#888; background:none; border:none;" onclick="localStorage.removeItem('vlm_history'); app.loadLog();">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
        </div>
    </div>

    <div id="view-advice" class="view">
        <button class="btn btn-back" onclick="app.navTo('view-home')">â† è¿”å›é¦–é </button>
        <div class="section-title">å°ˆå±¬é£²é£Ÿå»ºè­°</div>

        <div class="card" style="background: linear-gradient(135deg, #e0f2f1 0%, #80cbc4 100%); color: #004d40;">
            <h3>ä»Šæ—¥å¥åº·æé†’</h3>
            <p style="margin-top:5px; opacity:0.9;">é‡å° <span id="advice-patient-name" style="font-weight:bold;"></span> çš„å€‹äººåŒ–æŒ‡å°</p>
        </div>

        <div class="card">
            <h4>ğŸš« æ‡‰é¿å…çš„é£Ÿç‰©</h4>
            <ul id="advice-avoid" style="padding-left:20px; margin-top:10px; color:#c62828;">
                <li>è¼‰å…¥ä¸­...</li>
            </ul>
        </div>

        <div class="card">
            <h4>âœ… å»ºè­°æ”å–</h4>
            <ul id="advice-recommend" style="padding-left:20px; margin-top:10px; color:#2e7d32;">
                <li>è¼‰å…¥ä¸­...</li>
            </ul>
        </div>
    </div>

</div>

<div id="loading" class="loading-overlay">
    <div class="spinner"></div>
    <h3 style="margin-top:20px;">AI åˆ†æä¸­...</h3>
    <p style="color:#666; font-size:0.9rem;" id="loading-text">æ­£åœ¨è­˜åˆ¥é£Ÿç‰©ç¨®é¡...</p>
</div>

<script>
/**
 * NutriAI - SPA Logic
 */

// 1. Mock Data
const PATIENTS = [
    {
        name: "ç‹å°æ˜",
        age: 56, gender: "ç”·", height: 172, weight: 78,
        diseases: ["ç¬¬2å‹ç³–å°¿ç—…", "é«˜è¡€å£“"],
        meds: ["Metformin", "Amlodipine"],
        allergies: ["ç„¡"],
        goal: "åš´æ ¼æ§ç³–ã€æ¸›é‡",
        advice: {
            avoid: ["å«ç³–é£²æ–™ (å…¨ç³–çå¥¶ã€å¯æ¨‚)", "é«˜GIæ¾±ç²‰ (ç™½åå¸ã€ç³¯ç±³)", "é«˜éˆ‰åŠ å·¥å“ (é¦™è…¸ã€ç½é ­)"],
            recommend: ["é«˜çº–è”¬èœ (åœ°ç“œè‘‰ã€èŠ±æ¤°èœ)", "å„ªè³ªè›‹ç™½ (é›èƒ¸è‚‰ã€è±†è…)", "ä½GIå…¨ç©€ (ç³™ç±³ã€ç‡•éº¥)"]
        },
        conditions: { dm: true, htn: true, ckd: false }
    },
    {
        name: "æ—ç¾ç²",
        age: 68, gender: "å¥³", height: 155, weight: 52,
        diseases: ["æ…¢æ€§è…è‡Ÿç—… (CKD)", "ç—›é¢¨"],
        meds: ["åˆ©å°¿åŠ‘", "é™å°¿é…¸è—¥"],
        allergies: ["æµ·é®®"],
        goal: "ä½éˆ‰ã€ä½é‰€ã€ä½ç£·",
        advice: {
            avoid: ["é«˜é‰€æ°´æœ (é¦™è•‰ã€å¥‡ç•°æœ)", "å…§è‡Ÿé¡ã€é«˜æ¹¯", "å …æœèˆ‡å…¨ç©€é¡ (å«ç£·é«˜)"],
            recommend: ["ä½æ°®æ¾±ç²‰ (å†¬ç²‰ã€ç±³ç²‰)", "å·ç‡™è”¬èœ (å»é‰€)", "è›‹ç™½ (å„ªè³ªè›‹ç™½è³ª)"]
        },
        conditions: { dm: false, htn: true, ckd: true }
    }
];

const FOOD_DB = {
    bento: { name: "å°å¼æ’éª¨ä¾¿ç•¶", calories: 850, carbs: 105, protein: 35, fat: 38, sodium: 1200, risk: "High Sodium", tags: ["fried", "high_salt"] },
    salad: { name: "é›è‚‰å‡±è–©æ²™æ‹‰", calories: 350, carbs: 15, protein: 28, fat: 22, sodium: 600, risk: "Healthy", tags: ["raw"] },
    noodle: { name: "ç´…ç‡’ç‰›è‚‰éºµ", calories: 750, carbs: 85, protein: 45, fat: 28, sodium: 2400, risk: "Very High Sodium", tags: ["soup", "high_salt"] },
    burger: { name: "èµ·å¸ç‰›è‚‰æ¼¢å ¡", calories: 680, carbs: 45, protein: 32, fat: 40, sodium: 1350, risk: "High Fat", tags: ["processed"] }
};

// 2. App Logic
const app = {
    currentPatientIdx: 0,
    currentFile: null,

    init: function() {
        this.renderPatient();
        this.loadLog();
        this.navTo('view-home'); // Start at Dashboard
    },

    navTo: function(viewId) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        window.scrollTo(0,0);
        
        // Refresh specific views if needed
        if(viewId === 'view-log') this.loadLog();
        if(viewId === 'view-advice') this.renderAdvice();
    },

    switchPatient: function() {
        this.currentPatientIdx = (this.currentPatientIdx + 1) % PATIENTS.length;
        this.renderPatient();
        alert(`å·²åˆ‡æ›è‡³ç—…äººï¼š${PATIENTS[this.currentPatientIdx].name}`);
        this.renderAdvice(); // Update advice view content
    },

    renderPatient: function() {
        const p = PATIENTS[this.currentPatientIdx];
        const bmi = (p.weight / ((p.height/100) ** 2)).toFixed(1);
        
        // Header
        document.getElementById('header-patient-name').textContent = `ç•¶å‰ç—…äºº: ${p.name}`;
        
        // Profile View
        document.getElementById('p-name').textContent = p.name;
        document.getElementById('p-details').textContent = `${p.age}æ­² / ${p.gender} / ${p.height}cm / ${p.weight}kg`;
        document.getElementById('p-bmi').textContent = bmi;
        document.getElementById('p-goal').textContent = p.goal;

        const makeTags = (arr, cls, id) => {
            document.getElementById(id).innerHTML = arr.map(t => `<span class="tag ${cls}">${t}</span>`).join('');
        };
        makeTags(p.diseases, 'blue', 'p-diseases');
        makeTags(p.meds, 'red', 'p-meds');
        makeTags(p.allergies, 'red', 'p-allergies');
    },

    renderAdvice: function() {
        const p = PATIENTS[this.currentPatientIdx];
        document.getElementById('advice-patient-name').textContent = p.name;
        document.getElementById('advice-avoid').innerHTML = p.advice.avoid.map(t => `<li>${t}</li>`).join('');
        document.getElementById('advice-recommend').innerHTML = p.advice.recommend.map(t => `<li>${t}</li>`).join('');
    },

    handleFileSelect: function(e) {
        const file = e.target.files[0];
        if (file) {
            this.currentFile = file;
            const reader = new FileReader();
            reader.onload = (evt) => {
                document.getElementById('preview').src = evt.target.result;
                document.getElementById('preview').style.display = 'block';
                document.getElementById('upload-placeholder').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    },

    startAnalysis: function() {
        const loading = document.getElementById('loading');
        loading.style.display = 'flex';
        
        setTimeout(() => {
            // Mock VLM Result Logic
            const keys = Object.keys(FOOD_DB);
            let key;
            if (this.currentFile) {
                // Deterministic based on filename length
                key = keys[this.currentFile.name.length % keys.length];
            } else {
                // Random
                key = keys[Math.floor(Math.random() * keys.length)];
            }
            
            this.showResult(FOOD_DB[key]);
            loading.style.display = 'none';
        }, 2000);
    },

    showResult: function(food) {
        const p = PATIENTS[this.currentPatientIdx];
        
        // Generate UI
        document.getElementById('res-food-name').textContent = food.name;
        document.getElementById('res-confidence').textContent = (85 + Math.floor(Math.random()*14)) + "%";
        document.getElementById('res-ingredients').innerHTML = food.tags.map(t => `<span class="tag">${t}</span>`).join('');
        
        // Risk Logic
        const badge = document.getElementById('res-badge');
        const adviceBox = document.getElementById('res-advice-box');
        const advices = document.getElementById('res-advices');
        let adviceList = [];
        let status = "safe";

        if (p.conditions.ckd && food.sodium > 800) {
            status = "danger";
            adviceList.push("âš ï¸ é«˜éˆ‰å±éšªï¼šè…è‡Ÿç—…æ‚£è€…æ‡‰é¿å…å–æ¹¯");
        } else if (p.conditions.dm && food.carbs > 80) {
            status = "warn";
            adviceList.push("âš ï¸ æ§ç³–æé†’ï¼šç¢³æ°´åé«˜ï¼Œå»ºè­°é£¯é‡æ¸›åŠ");
        } else if (p.allergies.includes("æµ·é®®") && food.tags.includes("seafood")) {
            status = "danger";
            adviceList.push("âš ï¸ éæ•è­¦ç¤ºï¼šåµæ¸¬åˆ°æµ·é®®æˆåˆ†ï¼");
        } else {
            adviceList.push("âœ… ç¬¦åˆç›®å‰é£²é£Ÿæ§åˆ¶åŸå‰‡");
        }

        // Apply Styles
        badge.textContent = status === "danger" ? "ä¸å»ºè­°é£Ÿç”¨" : (status === "warn" ? "è¬¹æ…é£Ÿç”¨" : "æ¨è–¦é£Ÿç”¨");
        badge.style.color = status === "safe" ? "green" : (status === "danger" ? "red" : "orange");
        adviceBox.className = `recommendation-box ${status}`;
        advices.innerHTML = adviceList.map(t => `<li>${t}</li>`).join('');

        // Nutrition Bars
        const makeBar = (label, val, max) => `
            <div class="nutrition-row">
                <div>${label}</div>
                <div class="progress-bg"><div class="progress-fill" style="width:${Math.min((val/max)*100, 100)}%; background:${val>max*0.8 ? 'var(--danger)':'var(--secondary)'}"></div></div>
                <div style="text-align:right">${val}</div>
            </div>`;
        
        document.getElementById('nutrition-chart').innerHTML = 
            makeBar("ç†±é‡", food.calories, 1000) +
            makeBar("ç¢³æ°´", food.carbs, 100) +
            makeBar("è›‹ç™½è³ª", food.protein, 50) +
            makeBar("éˆ‰(mg)", food.sodium, 2000);

        document.getElementById('result-section').style.display = 'block';
        
        // Auto Save to Log
        this.saveLog(food, p.name, status);
    },

    saveLog: function(food, pName, status) {
        const record = {
            date: new Date().toLocaleString(),
            food: food.name,
            patient: pName,
            cals: food.calories,
            status: status
        };
        const logs = JSON.parse(localStorage.getItem('vlm_history') || '[]');
        logs.unshift(record);
        localStorage.setItem('vlm_history', JSON.stringify(logs));
        this.loadLog(); // Refresh log view
    },

    loadLog: function() {
        const logs = JSON.parse(localStorage.getItem('vlm_history') || '[]');
        const container = document.getElementById('log-list');
        
        if (logs.length === 0) {
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">å°šç„¡ç´€éŒ„</div>';
            return;
        }

        container.innerHTML = logs.map(l => {
            const color = l.status === 'danger' ? '#ffebee' : (l.status === 'warn' ? '#fff3e0' : '#e8f5e9');
            const icon = l.status === 'danger' ? 'âš ï¸' : (l.status === 'warn' ? 'âœ‹' : 'âœ…');
            return `
            <div class="log-item">
                <div class="log-icon" style="background:${color}">${icon}</div>
                <div>
                    <div style="font-weight:bold;">${l.food}</div>
                    <div style="font-size:0.8rem; color:#888;">${l.date} â€¢ ${l.patient}</div>
                </div>
                <div style="font-weight:bold; color:#666;">${l.cals} kcal</div>
            </div>`;
        }).join('');
    }
};

window.onload = () => app.init();
</script>
</body>
</html>
